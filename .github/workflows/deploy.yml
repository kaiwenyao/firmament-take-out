name: Deploy Firmament Server

on:
  push:
    branches: [ "main" ]
    # 只有当 main 分支有代码提交时触发

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v3

      - name: 设置 JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Maven 打包 (跳过测试以加快速度)
        # 注意：必须在根目录打包，这样才能正确识别 common 和 pojo 模块
        run: mvn clean package -DskipTests

      - name: 登录 Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 构建并推送到 Docker Hub
        uses: docker/build-push-action@v4
        with:
          # 指向刚才创建 Dockerfile 的目录
          context: ./firmament-server
          file: ./firmament-server/Dockerfile
          push: true
          # 这里的命名规则是：你的Docker用户名/仓库名:latest
          tags: ${{ secrets.DOCKER_USERNAME }}/firmament-server:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: SSH 远程登录并部署
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # 1. 创建存放配置文件的目录 (如果不存在)
            mkdir -p /opt/firmament/config
            
            # 2. 将 GitHub Secrets 中的环境变量文件写入服务器
            cat <<'EOF' > /opt/firmament/config/application-prod.env
            ${{ secrets.APPLICATION_PROD_ENV }}
            EOF
            chmod 600 /opt/firmament/config/application-prod.env
            
            # 3. 拉取最新的镜像
            docker pull ${{ secrets.DOCKER_USERNAME }}/firmament-server:latest
            
            # 4. 停止并删除旧容器 (如果存在)
            docker stop firmament-server || true
            docker rm firmament-server || true
            
            # 5. 启动新容器
            docker run -d \
            --name firmament-server \
            -p 8102:8080 \
            --network firmament_app-network \
            --env-file /opt/firmament/config/application-prod.env \
            ${{ secrets.DOCKER_USERNAME }}/firmament-server:latest
